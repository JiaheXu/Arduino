//Xbee TX setup:

#include <SoftwareSerial.h>
#define rxPin 2 //DOUT --> PIN 2
#define txPin 3 //DIN --> PIN 3
SoftwareSerial xbee = SoftwareSerial(rxPin, txPin);

int outPin = 12;    // pushbutton connected to digital pin 8
int inPin = 7;    // pushbutton connected to digital pin 8

// B on 20
// 7E 00 10 17 01 00 13 A2 00 41 90 8A 87 FF FE 02 44 31 05 D7
// B off 19
// 7E 00 0F 17 01 00 13 A2 00 41 90 8A 87 FF FE 02 46 52 B9

// C on 20
// 7E 00 10 17 01 00 13 A2 00 41 89 0E EE FF FE 02 44 31 05 F3
// C off 19
// 7E 00 0F 17 01 00 13 A2 00 41 89 0E EE FF FE 02 46 52 D5


// D on 20
// 7E 00 10 17 01 00 13 A2 00 41 90 89 B2 FF FE 02 44 31 05 AD
// D off 19
// 7E 00 0F 17 01 00 13 A2 00 41 90 89 B2 FF FE 02 46 52 8F

// ON means estop on, robot stop
// OFF means estop off, robot moves

// C for chrion A for index
byte CA_ON[] = {0x7E, 0x00, 0x10, 0x17, 0x01, 0x00, 0x13, 0xA2, 0x00, 0x42, 0x3E, 0x97, 0x16, 0xFF, 0xFE, 0x02, 0x44, 0x31, 0x05, 0x8C}; //20 D1
byte CA_OFF[] = {0x7E, 0x00, 0x0F, 0x17, 0x01, 0x00, 0x13, 0xA2, 0x00, 0x42, 0x3E, 0x97, 0x16, 0xFF, 0xFE, 0x02, 0x46, 0x52, 0x6E}; //19 FR

byte CB_ON[] = {0x7E, 0x00, 0x10, 0x17, 0x01, 0x00, 0x13, 0xA2, 0x00, 0x42, 0x3E, 0x97, 0x77, 0xFF, 0xFE, 0x02, 0x44, 0x31, 0x05, 0x2B}; //20 D1
byte CB_OFF[] = {0x7E, 0x00, 0x0F, 0x17, 0x01, 0x00, 0x13, 0xA2, 0x00, 0x42, 0x3E, 0x97, 0x77, 0xFF, 0xFE, 0x02, 0x46, 0x52, 0x0D}; //19 FR

byte CC_ON[] = {0x7E, 0x00, 0x10, 0x17, 0x01, 0x00, 0x13, 0xA2, 0x00, 0x42, 0x3E, 0x96, 0x7C, 0xFF, 0xFE, 0x02, 0x44, 0x31, 0x05, 0x27}; //20 D1
byte CC_OFF[] = {0x7E, 0x00, 0x0F, 0x17, 0x01, 0x00, 0x13, 0xA2, 0x00, 0x42, 0x3E, 0x96, 0x7C, 0xFF, 0xFE, 0x02, 0x46, 0x52, 0x09}; //19 FR


byte CD_ON[] = {0x7E, 0x00, 0x10, 0x17, 0x01, 0x00, 0x13, 0xA2, 0x00, 0x42, 0x44, 0xCF, 0x50, 0xFF, 0xFE, 0x02, 0x44, 0x31, 0x05, 0x14}; //20 D1
byte CD_OFF[] = {0x7E, 0x00, 0x0F, 0x17, 0x01, 0x00, 0x13, 0xA2, 0x00, 0x42, 0x44, 0xCF, 0x50, 0xFF, 0xFE, 0x02, 0x46, 0x52, 0xF6}; //19 FR

byte CE_ON[] = {0x7E, 0x00, 0x10, 0x17, 0x01, 0x00, 0x13, 0xA2, 0x00, 0x42, 0x44, 0xD0, 0x4B, 0xFF, 0xFE, 0x02, 0x44, 0x31, 0x05, 0x18}; //20 D1
byte CE_OFF[] = {0x7E, 0x00, 0x0F, 0x17, 0x01, 0x00, 0x13, 0xA2, 0x00, 0x42, 0x44, 0xD0, 0x4B, 0xFF, 0xFE, 0x02, 0x46, 0x52, 0xFA}; //19 FR

byte CF_ON[] = {0x7E, 0x00, 0x10, 0x17, 0x01, 0x00, 0x13, 0xA2, 0x00, 0x41, 0x89, 0x0E, 0xEE, 0xFF, 0xFE, 0x02, 0x44, 0x31, 0x05, 0xF3}; //20 D1
byte CF_OFF[] = {0x7E, 0x00, 0x0F, 0x17, 0x01, 0x00, 0x13, 0xA2, 0x00, 0x41, 0x89, 0x0E, 0xEE, 0xFF, 0xFE, 0x02, 0x46, 0x52, 0xD5}; //19 FR

// RGB set
#include <Adafruit_NeoPixel.h>
#ifdef __AVR__
  #include <avr/power.h>
#endif
#define PIN        5
#define NUMPIXELS 7

Adafruit_NeoPixel pixels(NUMPIXELS, PIN, NEO_GRB + NEO_KHZ800);
#define DELAYVAL 500

void setup() {
  Serial.begin(9600);
  Serial.println("Remote E-Stop");
  //xbee setup
  pinMode(rxPin, INPUT);
  pinMode(txPin, OUTPUT);
  xbee.begin(9600);


  pinMode(outPin, OUTPUT);  // sets the digital pin 13 as output
  

  pinMode(inPin, INPUT);    // sets the digital pin 8 as input




  #if defined(__AVR_ATtiny85__) && (F_CPU == 16000000)
  clock_prescale_set(clock_div_1);
  #endif

  pixels.begin();
}


void trigger_all()
{
  xbee.write(CA_ON,20);
  xbee.write(CB_ON,20);
  xbee.write(CC_ON,20);
  xbee.write(CD_ON,20);
  xbee.write(CE_ON,20);
  xbee.write(CF_ON,20);
}

void reset_all()
{
  xbee.write(CA_OFF,19);
  xbee.write(CB_OFF,19);
  xbee.write(CC_OFF,19);
  xbee.write(CD_OFF,19);
  xbee.write(CE_OFF,19);
  xbee.write(CF_OFF,19);
}

int val = 0;
int last_val = -1;
void loop()
{

  pixels.clear();

  digitalWrite(outPin, HIGH);
  val = digitalRead(inPin);
  if( val == HIGH)
  {
    if(last_val != val)
      trigger_all();
    // Serial.println("ON ON ON ON ON ON");

    for(int i=0; i<NUMPIXELS; i++) 
    {
      pixels.setPixelColor(i, pixels.Color(150, 0, 0));
      pixels.show();
    }
    delay(300);

  }
  else
  {
    if(last_val != val)
      reset_all();
    // Serial.println("OFF OFF OFF OFF OFF OFF");
    for(int i=0; i<NUMPIXELS; i++) 
    {
      pixels.setPixelColor(i, pixels.Color(0, 150, 0));
      pixels.show();
    }
    delay(300);    
    // if(last_val == HIGH)
    // {
    //   reset_all();
    // }
  }
  // last_val = val;
  // trigger_all();
  // delay(2000);
  // reset_all();
  // delay(2000);
  last_val = val;

}