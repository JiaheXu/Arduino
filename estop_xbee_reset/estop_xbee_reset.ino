//Xbee TX setup:
#include <SoftwareSerial.h>
#define rxPin 2 //DOUT --> PIN 2
#define txPin 3 //DIN --> PIN 3
SoftwareSerial xbee = SoftwareSerial(rxPin, txPin);

/*************************************************************************************/
/*To generate frames in XCTU API Frames Generator
Mode API 1
Frame Type: 0x17
Frame ID: 01
64-bit dest address: radio address
16-bit dest address: FF FE
Remote cmd. options: 02
AT command (hex):   _ON: 64 31
                    _OFF: 66 72
Parameter Value(hex):  _ON:  05
                       _OFF: NOT USED
*/

//Our frames to send:
byte estop_ON_R1[] = {0x7E, 0x00, 0x10, 0x17, 0x01, 0x00, 0x13, 0xA2, 0x00, 0x41, 0x90, 0x89, 0xB2, 0xFF, 0xFE, 0x02, 0x64, 0x31, 0x05, 0x8D};
//7E 00 10 17 01 00 13 A2 00 41 90 89 B2 FF FE 02 64 31 05 8D
byte estop_OFF_R1[] = {0x7E, 0x00, 0x0F, 0x17, 0x01, 0x00, 0x13, 0xA2, 0x00, 0x41, 0x90, 0x89, 0xB2, 0xFF, 0xFE, 0x02, 0x66, 0x72, 0x4F};
//7E 00 0F 17 01 00 13 A2 00 41 90 89 B2 FF FE 02 66 72 4F
byte estop_ON_R2[] = {0x7E, 0x00, 0x10, 0x17, 0x01, 0x00, 0x13, 0xA2, 0x00, 0x41, 0x90, 0x8A, 0x87, 0xFF, 0xFE, 0x02, 0x64, 0x31, 0x05, 0xB7};
//7E 00 10 17 01 00 13 A2 00 41 90 8A 87 FF FE 02 64 31 05 B7
byte estop_OFF_R2[] = {0x7E, 0x00, 0x0F, 0x17, 0x01, 0x00, 0x13, 0xA2, 0x00, 0x41, 0x90, 0x8A, 0x87, 0xFF, 0xFE, 0x02, 0x66, 0x72, 0x79};
//7E 00 0F 17 01 00 13 A2 00 41 90 8A 87 FF FE 02 66 72 79
byte estop_ON_R3[] = {0x7E, 0x00, 0x10, 0x17, 0x01, 0x00, 0x13, 0xA2, 0x00, 0x41, 0xA1, 0x1A, 0x8E, 0xFF, 0xFE, 0x02, 0x64, 0x31, 0x05, 0x0F};
//7E 00 10 17 01 00 13 A2 00 41 A1 1A 8E FF FE 02 64 31 05 0F
byte estop_OFF_R3[] = {0x7E, 0x00, 0x0F, 0x17, 0x01, 0x00, 0x13, 0xA2, 0x00, 0x41, 0xA1, 0x1A, 0x8E, 0xFF, 0xFE, 0x02, 0x66, 0x72, 0xD1};
//7E 00 0F 17 01 00 13 A2 00 41 A1 1A 8E FF FE 02 66 72 D1
//disengage = 7E 00 10 17 01 00 7D 33 A2 00 41 90 8A 87 FF FE 02 44 31 05 D7
byte engage_R1[] = {0x7E, 0x00, 0x10, 0x17, 0x01, 0x00, 0x13, 0xA2, 0x00, 0x41, 0x90, 0x89, 0xB2, 0xFF, 0xFE, 0x02, 0x64, 0x31, 0x05, 0x8D};
byte disengage_R1[] = {0x7E, 0x00, 0x0F, 0x17, 0x01, 0x00, 0x13, 0xA2, 0x00, 0x41, 0x90, 0x89, 0xB2, 0xFF, 0xFE, 0x02, 0x66, 0x72, 0x4F};
byte engage_R2[] = {0x7E, 0x00, 0x10, 0x17, 0x01, 0x00, 0x13, 0xA2, 0x00, 0x41, 0x90, 0x8A, 0x87, 0xFF, 0xFE, 0x02, 0x64, 0x31, 0x05, 0xB7};
byte disengage_R2[] = {0x7E, 0x00, 0x0F, 0x17, 0x01, 0x00, 0x13, 0xA2, 0x00, 0x41, 0x90, 0x8A, 0x87, 0xFF, 0xFE, 0x02, 0x66, 0x72, 0x79};

// Spot with radio B3 6/16/2021
byte estop_ON_SPOT1[] = {0x7E, 0x00, 0x10, 0x17, 0x01, 0x00, 0x13, 0xA2, 0x00, 0x41, 0xBA, 0xC2, 0xD8, 0xFF, 0xFE, 0x02, 0x64, 0x31, 0x05, 0x04};
//7E 00 10 17 01 00 13 A2 00 41 BA C2 D8 FF FE 02 64 31 05 04
byte estop_OFF_SPOT1[] = {0x7E, 0x00, 0x0F, 0x17, 0x01, 0x00, 0x13, 0xA2, 0x00, 0x41, 0xBA, 0xC2, 0xD8, 0xFF, 0xFE, 0x02, 0x66, 0x72, 0xC6};
//7E 00 0F 17 01 00 13 A2 00 41 BA C2 D8 FF FE 02 66 72 C6


void setup() {
  Serial.begin(9600);
  Serial.println("Remote E-Stop");

  //xbee setup
  pinMode(rxPin, INPUT);
  pinMode(txPin, OUTPUT);
  xbee.begin(9600);

  //Switch setup
  pinMode(8, INPUT_PULLUP);
}

void loop() {

  int switchValue = LOW;
  int lastValue = switchValue;

  while (1) {

    switchValue = digitalRead(8);
    //Serial.println(switchValue, DEC);
    if (switchValue == HIGH && lastValue != HIGH) {
      xbee.write("/n/r",2);
      xbee.write(engage_R1,21);
      xbee.write("/n/r",2);
      delay(30);
      xbee.write("/n/r", 2);
      xbee.write(engage_R2,21);
      xbee.write("/n/r",2);
      delay(30);
      xbee.write("/n/r", 2);
      xbee.write(estop_ON_R3,21);
      xbee.write("/n/r",2);
      delay(30);
//      xbee.write("/n/r", 2);
//      xbee.write(estop_ON_SPOT1,20);
//      xbee.write("/n/r",2);
      
      Serial.println("E-Stop Engaged");
      lastValue = switchValue;
    }
    if (switchValue == LOW && lastValue != LOW) {
      xbee.write("/n/r",2);
      xbee.write(disengage_R1,21);
      xbee.write("/n/r", 2);
      delay(30);
      xbee.write("/n/r",2);
      xbee.write(disengage_R2,21);
      xbee.write("/n/r",2);
      delay(30);
      xbee.write("/n/r",2);
      xbee.write(estop_OFF_R3,21);
      xbee.write("/n/r",2);
      delay(30);
//     xbee.write("/n/r",2);
//     xbee.write(estop_OFF_SPOT1,21);
//      xbee.write("/n/r",2);

      Serial.println("E-Stop Disengage");
      lastValue = switchValue;
    }
  }
}
